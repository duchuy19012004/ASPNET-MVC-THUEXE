@model bike.Models.ChiTietHopDong
@{
    ViewData["Title"] = "Thêm Xe Vào Hợp Đồng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var hopDong = ViewBag.HopDong as bike.Models.HopDong;
}

<style>
    .add-vehicle-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px 0;
    }

    .add-vehicle-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        text-align: center;
    }

    .add-vehicle-body {
        background: white;
        padding: 30px;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .contract-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        border-left: 4px solid #667eea;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #666;
        font-weight: 500;
    }

    .info-value {
        color: #333;
        font-weight: bold;
    }

    .vehicle-form {
        background: #ffffff;
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 25px;
    }

    .calculation-section {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .calc-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .calc-total {
        font-weight: bold;
        font-size: 18px;
        color: #1976d2;
        border-top: 2px solid #1976d2;
        padding-top: 10px;
        margin-top: 10px;
    }

    .btn-add-vehicle {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 8px;
        width: 100%;
    }
</style>

<div class="add-vehicle-container">
    <!-- Header -->
    <div class="add-vehicle-header">
        <h2><i class="bi bi-plus-circle"></i> Thêm Xe Vào Hợp Đồng</h2>
        <p class="mb-0">Hợp đồng: HD@(hopDong.MaHopDong.ToString("D6"))</p>
    </div>

    <!-- Body -->
    <div class="add-vehicle-body">
        <!-- Thông tin hợp đồng -->
        <h4 class="mb-3"><i class="bi bi-info-circle"></i> Thông tin hợp đồng</h4>
        <div class="contract-info">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-row">
                        <span class="info-label">Khách hàng:</span>
                        <span class="info-value">@hopDong.HoTenKhach</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Số điện thoại:</span>
                        <span class="info-value">@hopDong.SoDienThoai</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Trạng thái:</span>
                        <span class="info-value text-success">@hopDong.TrangThai</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-row">
                        <span class="info-label">Ngày nhận xe:</span>
                        <span class="info-value">@hopDong.NgayNhanXe.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ngày trả dự kiến:</span>
                        <span class="info-value">@hopDong.NgayTraXeDuKien.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tổng tiền hiện tại:</span>
                        <span class="info-value text-primary">@hopDong.TongTien.ToString("N0")đ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form thêm xe -->
        <h4 class="mb-3"><i class="bi bi-plus-square"></i> Thêm xe mới</h4>
        <div class="vehicle-form">
            <form asp-action="ThemXe" method="post">
                <input type="hidden" asp-for="MaHopDong" />
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="MaXe" class="form-label">Chọn xe <span class="text-danger">*</span></label>
                            <select asp-for="MaXe" class="form-select" asp-items="ViewBag.XeList" required onchange="updateVehicleInfo()">
                                <option value="">-- Chọn xe --</option>
                            </select>
                            <span asp-validation-for="MaXe" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Thông tin xe</label>
                            <div id="vehicleInfo" class="form-control" style="height: auto; background: #f8f9fa; color: #666;">
                                Chọn xe để xem thông tin
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="NgayNhanXe" class="form-label">Ngày nhận xe <span class="text-danger">*</span></label>
                            <input type="date" asp-for="NgayNhanXe" class="form-control" required onchange="calculateAmount()" />
                            <span asp-validation-for="NgayNhanXe" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="NgayTraXeDuKien" class="form-label">Ngày trả xe dự kiến <span class="text-danger">*</span></label>
                            <input type="date" asp-for="NgayTraXeDuKien" class="form-control" required onchange="calculateAmount()" />
                            <span asp-validation-for="NgayTraXeDuKien" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="GhiChu" class="form-label">Ghi chú</label>
                    <textarea asp-for="GhiChu" class="form-control" rows="3" placeholder="Ghi chú thêm cho xe này..."></textarea>
                    <span asp-validation-for="GhiChu" class="text-danger"></span>
                </div>

                <!-- Tính toán -->
                <div class="calculation-section">
                    <h5 class="mb-3">Tính toán chi phí</h5>
                    <div class="calc-row">
                        <span>Số ngày thuê:</span>
                        <span id="soNgayThue">0 ngày</span>
                    </div>
                    <div class="calc-row">
                        <span>Giá thuê/ngày:</span>
                        <span id="giaThueNgay">0đ</span>
                    </div>
                    <div class="calc-row calc-total">
                        <span>Thành tiền:</span>
                        <span id="thanhTien">0đ</span>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-3 mt-4">
                    <button type="submit" class="btn btn-add-vehicle flex-fill">
                        <i class="bi bi-plus-circle"></i> Thêm Xe Vào Hợp Đồng
                    </button>
                    <a asp-controller="QuanLyHopDong" asp-action="ChiTiet" asp-route-id="@Model.MaHopDong" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Quay lại
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    
    <script>
        let vehicleData = {};

        // Load thông tin xe khi chọn
        function updateVehicleInfo() {
            const maXe = document.getElementById('MaXe').value;
            const infoDiv = document.getElementById('vehicleInfo');
            
            if (!maXe) {
                infoDiv.innerHTML = 'Chọn xe để xem thông tin';
                document.getElementById('giaThueNgay').textContent = '0đ';
                calculateAmount();
                return;
            }

            // Call API để lấy thông tin xe
            fetch(`@Url.Action("GetXeInfo", "ChiTietHopDong")?maXe=${maXe}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        vehicleData = result.data;
                        infoDiv.innerHTML = `
                            <strong>${result.data.tenXe}</strong><br>
                            Biển số: ${result.data.bienSoXe}<br>
                            Hãng: ${result.data.hangXe} ${result.data.dongXe}<br>
                            Giá: ${result.data.giaThue.toLocaleString('vi-VN')}đ/ngày
                        `;
                        document.getElementById('giaThueNgay').textContent = result.data.giaThue.toLocaleString('vi-VN') + 'đ';
                        calculateAmount();
                    } else {
                        infoDiv.innerHTML = 'Không thể tải thông tin xe';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    infoDiv.innerHTML = 'Lỗi khi tải thông tin xe';
                });
        }

        // Tính toán số tiền
        function calculateAmount() {
            const ngayNhan = document.getElementById('NgayNhanXe').value;
            const ngayTra = document.getElementById('NgayTraXeDuKien').value;
            
            if (ngayNhan && ngayTra && vehicleData.giaThue) {
                const startDate = new Date(ngayNhan);
                const endDate = new Date(ngayTra);
                const dayDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                if (dayDiff > 0) {
                    const tongTien = dayDiff * vehicleData.giaThue;
                    
                    document.getElementById('soNgayThue').textContent = dayDiff + ' ngày';
                    document.getElementById('thanhTien').textContent = tongTien.toLocaleString('vi-VN') + 'đ';
                } else {
                    document.getElementById('soNgayThue').textContent = '0 ngày';
                    document.getElementById('thanhTien').textContent = '0đ';
                }
            } else {
                document.getElementById('soNgayThue').textContent = '0 ngày';
                document.getElementById('thanhTien').textContent = '0đ';
            }
        }

        // Set validation cho ngày
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('NgayNhanXe').min = today;
            
            document.getElementById('NgayNhanXe').addEventListener('change', function() {
                const ngayNhanXe = new Date(this.value);
                ngayNhanXe.setDate(ngayNhanXe.getDate() + 1);
                document.getElementById('NgayTraXeDuKien').min = ngayNhanXe.toISOString().split('T')[0];
            });
        });
    </script>
} 