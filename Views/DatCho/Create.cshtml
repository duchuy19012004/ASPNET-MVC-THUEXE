@model bike.ViewModels.DatChoViewModel
@{
    ViewData["Title"] = "Đặt Giữ Chỗ";
    Layout = "~/Views/Shared/_HomePage.cshtml";
}

<style>
    .reservation-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 30px 0;
    }
    
    .reservation-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        text-align: center;
    }
    
    .reservation-body {
        background: white;
        padding: 30px;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.1);
    }
    
    /* Thông tin xe */
    .vehicle-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .vehicle-image {
        width: 150px;
        height: 100px;
        object-fit: cover;
        border-radius: 10px;
    }
    
    .price-highlight {
        font-size: 24px;
        font-weight: bold;
        color: #ff0080;
    }
    
    /* Form */
    .form-section {
        margin-bottom: 30px;
    }
    
    .form-section h4 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .date-inputs {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .date-inputs > div {
        flex: 1;
    }
    
    .rental-period-input {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .rental-period-input .form-label {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .rental-period-input .input-group {
        max-width: 200px;
    }
    
    .rental-period-input .form-control {
        text-align: center;
        font-weight: bold;
        font-size: 18px;
    }
    
    .rental-period-input .input-group-text {
        background: #667eea;
        color: white;
        border: none;
        font-weight: bold;
    }
    
    .rental-period-input .btn-outline-primary {
        border-color: #667eea;
        color: #667eea;
        transition: all 0.3s ease;
    }
    
    .rental-period-input .btn-outline-primary:hover,
    .rental-period-input .btn-outline-primary.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
        transform: translateY(-1px);
    }
    
    /* Summary */
    .booking-summary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .total-price {
        font-size: 28px;
        font-weight: bold;
        border-top: 2px solid rgba(255,255,255,0.3);
        padding-top: 10px;
        margin-top: 10px;
    }
    
    /* Buttons */
    .btn-reserve {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 10px;
        width: 100%;
        transition: all 0.3s;
    }
    
    .btn-reserve:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* Modal xác nhận đặt chỗ */
    #confirmBookingModal .modal-content {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    #confirmBookingModal .modal-header {
        border-radius: 15px 15px 0 0;
        border-bottom: none;
    }
    
    #confirmBookingModal .modal-footer {
        border-top: none;
        padding-top: 0;
    }
    
    #confirmBookingModal .btn {
        border-radius: 10px;
        padding: 10px 30px;
        font-weight: bold;
        min-width: 120px;
    }
    
    #confirmBookingModal .btn-success:hover {
        background-color: #198754;
        transform: translateY(-1px);
    }
    
    #confirmBookingModal .btn-secondary:hover {
        background-color: #5c636a;
        transform: translateY(-1px);
    }
    
    /* Đảm bảo modal hiển thị trên cùng */
    #confirmBookingModal {
        z-index: 99999 !important;
    }
    
    #confirmBookingModal .modal-backdrop {
        z-index: 99998 !important;
    }
    
    .modal-backdrop.show {
        z-index: 99998 !important;
    }
</style>

<div class="reservation-container">
    <div class="reservation-header">
        <h2><i class="bi bi-calendar-check"></i> Đặt Giữ Chỗ</h2>
        <p class="mb-0">Hoàn tất thông tin để giữ xe</p>
    </div>

    <div class="reservation-body">
        <!-- Thông tin xe -->
        <div class="vehicle-info">
            <div class="row align-items-center">
                <div class="col-md-3">
               @if (!string.IsNullOrEmpty(Model.HinhAnhHienThi))
                        {
                            <img src="/images/xe/@Model.HinhAnhHienThi" alt="@Model.TenXe" class="vehicle-image" />
                    }
                    else
                    {
                        <img src="/images/default.jpg" alt="@Model.TenXe" class="vehicle-image" />
                    }
                </div>
                <div class="col-md-6">
                    <h3>@Model.TenXe</h3>
                    @*
                    <p class="mb-1"><i class="bi bi-card-text"></i> Biển số: <strong>@Model.BienSoXe</strong></p>
                    *@
                    <p class="mb-0"><i class="bi bi-cash"></i> Giá thuê: <span class="price-highlight">@Model.GiaThue.ToString("N0")đ/ngày</span></p>
                </div>
                <div class="col-md-3 text-center">
                    <span class="badge bg-success p-3">Sẵn sàng</span>
                </div>
            </div>
        </div>

        <form asp-action="Create" method="post" id="datChoForm">
            <input type="hidden" asp-for="MaXe" />

            <!-- Thông tin người đặt -->
            <div class="form-section">
                <h4><i class="bi bi-person"></i> Thông tin người đặt</h4>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="HoTen" class="form-label"></label>
                            <input asp-for="HoTen" class="form-control" placeholder="Nhập họ và tên" required />
                            <span asp-validation-for="HoTen" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="SoDienThoai" class="form-label"></label>
                            <input asp-for="SoDienThoai" class="form-control" placeholder="Nhập số điện thoại" required />
                            <span asp-validation-for="SoDienThoai" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Email" class="form-label"></label>
                    <input asp-for="Email" class="form-control" placeholder="Nhập email" required />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>
            </div>

            <!-- Thời gian thuê -->
            <div class="form-section">
                <h4><i class="bi bi-calendar"></i> Thời gian thuê</h4>

                <!-- Tùy chọn nhanh: Nhập số ngày thuê -->
                <div class="rental-period-input">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-lightning"></i> Tùy chọn nhanh</label>
                            <div class="input-group">
                                <input type="number" id="soNgayThueInput" class="form-control" placeholder="2" min="1" max="30" value="2" oninput="calculateFromDays()" />
                                <span class="input-group-text">ngày</span>
                            </div>
                            <small class="text-muted">Nhập số ngày thuê (1-30 ngày)</small>
                            
                            <!-- Các tùy chọn nhanh -->
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="setRentalDays(1)">1 ngày</button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="setRentalDays(3)">3 ngày</button>
                                <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="setRentalDays(7)">1 tuần</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setRentalDays(14)">2 tuần</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <small class="text-muted">hoặc chọn ngày cụ thể bên dưới</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chọn ngày cụ thể -->
                <div class="date-inputs">
                    <div>
                        <label asp-for="NgayNhanXe" class="form-label"></label>
                        <input asp-for="NgayNhanXe" class="form-control" type="date" onchange="calculatePrice()" required />
                        <span asp-validation-for="NgayNhanXe" class="text-danger"></span>
                    </div>
                    <div>
                        <label asp-for="NgayTraXe" class="form-label"></label>
                        <input asp-for="NgayTraXe" class="form-control" type="date" onchange="calculatePrice()" required />
                        <span asp-validation-for="NgayTraXe" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Ghi chú -->
            <div class="form-section">
                <h4><i class="bi bi-chat-left-text"></i> Ghi chú (tùy chọn)</h4>
                <textarea asp-for="GhiChu" class="form-control" rows="3" placeholder="Nhập ghi chú nếu có..."></textarea>
            </div>

            <!-- Tổng kết -->
            <div class="booking-summary">
                <h4 class="mb-3">Tổng kết đặt chỗ</h4>
                <div class="summary-row">
                    <span>Số ngày thuê:</span>
                    <span id="soNgayThue">3 ngày</span>
                </div>
                <div class="summary-row">
                    <span>Giá thuê/ngày:</span>
                    <span>@Model.GiaThue.ToString("N0")đ</span>
                </div>
                <div class="summary-row total-price">
                    <span>Tổng tiền dự kiến:</span>
                    <span id="tongTien">@((Model.GiaThue * 3).ToString("N0"))đ</span>
                </div>
            </div>

            <!-- Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-reserve" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Đặt Chỗ Đi
                </button>
                <a asp-controller="Home" asp-action="XemChiTiet" asp-route-id="@Model.MaXe" class="btn btn-link text-center d-block mt-3">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal xác nhận đặt chỗ -->
<div class="modal fade" id="confirmBookingModal" tabindex="-1" aria-labelledby="confirmBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmBookingModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Xác nhận đặt chỗ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="bi bi-question-circle-fill text-warning" style="font-size: 3rem;"></i>
                </div>
                <h6 class="mb-3">Bạn có chắc chắn muốn đặt giữ chỗ cho xe này không?</h6>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Sau khi xác nhận, thông tin đặt chỗ sẽ được gửi và bạn cần liên hệ để hoàn tất thủ tục.
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Hủy bỏ
                </button>
                <button type="button" class="btn btn-success" id="confirmBookingBtn">
                    <i class="bi bi-check-circle"></i> Đồng ý, đặt chỗ!
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Biến để kiểm tra xem đã xác nhận chưa
        var isConfirmed = false;
        var currentForm = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Tìm form
            const form = document.getElementById('datChoForm');
            const confirmModal = document.getElementById('confirmBookingModal');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            

            
            if (form) {
                // Xử lý sự kiện submit form
                form.addEventListener('submit', function(e) {
                    // Nếu chưa xác nhận, ngăn submit và hiển thị modal
                    if (!isConfirmed) {
                        e.preventDefault();
                        
                        // Kiểm tra validation trước khi hiển thị modal
                        let isValid = true;
                        
                        // Kiểm tra các trường bắt buộc
                        const requiredFields = form.querySelectorAll('input[required], select[required]');
                        
                        requiredFields.forEach(function(field) {
                            if (!field.value.trim()) {
                                isValid = false;
                                field.classList.add('is-invalid');
                            } else {
                                field.classList.remove('is-invalid');
                            }
                        });
                        
                        // Nếu form hợp lệ, hiển thị modal xác nhận
                        if (isValid) {
                            currentForm = this;
                            try {
                                const modal = new bootstrap.Modal(confirmModal);
                                modal.show();
                            } catch (error) {
                                // Fallback: sử dụng confirm dialog
                                if (confirm('Bạn có chắc chắn muốn đặt giữ chỗ cho xe này không?')) {
                                    isConfirmed = true;
                                    this.submit();
                                }
                            }
                        } else {
                            // Scroll đến trường đầu tiên có lỗi
                            const firstInvalid = form.querySelector('.is-invalid');
                            if (firstInvalid) {
                                firstInvalid.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center' 
                                });
                            }
                        }
                    }
                });
            }
            
            // Thêm event listener cho nút submit button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    if (!isConfirmed) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Hiển thị modal trực tiếp
                        if (confirmModal) {
                            try {
                                const modal = new bootstrap.Modal(confirmModal);
                                modal.show();
                                currentForm = form;
                            } catch (error) {
                                // Fallback: sử dụng confirm dialog
                                if (confirm('Bạn có chắc chắn muốn đặt giữ chỗ cho xe này không?')) {
                                    isConfirmed = true;
                                    form.submit();
                                }
                            }
                        } else {
                            // Fallback: sử dụng confirm dialog
                            if (confirm('Bạn có chắc chắn muốn đặt giữ chỗ cho xe này không?')) {
                                isConfirmed = true;
                                form.submit();
                            }
                        }
                    }
                });
            }

            // Xử lý khi click nút xác nhận trong modal
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    if (currentForm) {
                        // Đánh dấu đã xác nhận
                        isConfirmed = true;
                        
                        // Đóng modal
                        const modal = bootstrap.Modal.getInstance(confirmModal);
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Submit form sau một chút delay
                        setTimeout(function() {
                            currentForm.submit();
                        }, 300);
                    }
                });
            }

            // Reset trạng thái khi đóng modal
            if (confirmModal) {
                confirmModal.addEventListener('hidden.bs.modal', function () {
                    if (!isConfirmed) {
                        currentForm = null;
                    }
                });
            }
        });
        // Lấy giá thuê từ Model
        var giaThue = @Html.Raw(Model.GiaThue)

        // Tính toán từ số ngày thuê được nhập
        function calculateFromDays() {
            const soNgayInput = document.getElementById('soNgayThueInput');
            const ngayNhanInput = document.getElementById('NgayNhanXe');
            const ngayTraInput = document.getElementById('NgayTraXe');
            
            let soNgay = parseInt(soNgayInput.value) || 2;
            
            // Giới hạn từ 1-30 ngày
            if (soNgay < 1) soNgay = 1;
            if (soNgay > 30) soNgay = 30;
            soNgayInput.value = soNgay;
            
            // Tính toán ngày trả dựa trên ngày nhận và số ngày thuê
            const ngayNhan = new Date(ngayNhanInput.value);
            if (ngayNhan) {
                const ngayTra = new Date(ngayNhan);
                ngayTra.setDate(ngayNhan.getDate() + soNgay - 1);
                
                // Cập nhật ngày trả
                ngayTraInput.value = ngayTra.toISOString().split('T')[0];
                
                // Tính toán lại giá
                calculatePrice();
            }
        }

        // Hàm set số ngày thuê từ các nút preset
        function setRentalDays(days) {
            const soNgayInput = document.getElementById('soNgayThueInput');
            soNgayInput.value = days;
            
            // Highlight button được chọn
            const buttons = document.querySelectorAll('.rental-period-input .btn-outline-primary');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Tìm button tương ứng và highlight
            const activeButton = [...buttons].find(btn => btn.textContent.includes(days.toString()));
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Tự động tính toán
            calculateFromDays();
        }

        // Tính toán giá và số ngày
        function calculatePrice() {
            const ngayNhan = new Date(document.getElementById('NgayNhanXe').value);
            const ngayTra = new Date(document.getElementById('NgayTraXe').value);

            if (ngayNhan && ngayTra && ngayTra >= ngayNhan) {
                const soNgay = Math.ceil((ngayTra - ngayNhan) / (1000 * 60 * 60 * 24)) + 1;
                const tongTien = soNgay * giaThue;

                document.getElementById('soNgayThue').textContent = soNgay + ' ngày';
                document.getElementById('tongTien').textContent = tongTien.toLocaleString('vi-VN') + 'đ';
                
                // Cập nhật input số ngày thuê để đồng bộ
                document.getElementById('soNgayThueInput').value = soNgay;
                
                // Highlight button preset tương ứng
                updatePresetButtons(soNgay);
            }
        }

        // Cập nhật trạng thái của các nút preset
        function updatePresetButtons(currentDays) {
            const buttons = document.querySelectorAll('.rental-period-input .btn-outline-primary');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                
                // Kiểm tra nếu button này tương ứng với số ngày hiện tại
                if ((currentDays === 1 && btn.textContent.includes('1 ngày')) ||
                    (currentDays === 3 && btn.textContent.includes('3 ngày')) ||
                    (currentDays === 7 && btn.textContent.includes('1 tuần')) ||
                    (currentDays === 14 && btn.textContent.includes('2 tuần'))) {
                    btn.classList.add('active');
                }
            });
        }

        // Khởi tạo khi load trang
        document.addEventListener('DOMContentLoaded', function() {
            // Set giá trị mặc định cho các input date
            const today = new Date();
            const ngayNhanInput = document.getElementById('NgayNhanXe');
            const ngayTraInput = document.getElementById('NgayTraXe');
            
            if (!ngayNhanInput.value) {
                ngayNhanInput.value = today.toISOString().split('T')[0];
            }
            
            if (!ngayTraInput.value) {
                const ngayTra = new Date(today);
                ngayTra.setDate(today.getDate() + 1);
                ngayTraInput.value = ngayTra.toISOString().split('T')[0];
            }
            
            // Tính toán ban đầu
            calculatePrice();
        });

        // Real-time validation
        $(document).ready(function() {
            // Validate họ tên
            $('#HoTen').on('blur', function() {
                const hoTen = $(this).val();
                const $input = $(this);
                const $error = $input.siblings('.text-danger');

                if (hoTen.length < 3) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    if ($error.length === 0) {
                        $input.after('<span class="text-danger">Họ tên phải có ít nhất 3 ký tự</span>');
                    } else {
                        $error.text('Họ tên phải có ít nhất 3 ký tự');
                    }
                } else {
                    $input.removeClass('is-invalid').addClass('is-valid');
                    $error.text('');
                }
            });

            // Validate số điện thoại real-time
            $('#SoDienThoai').on('input', function() {
                const sdt = $(this).val();
                const $input = $(this);
                let $error = $input.siblings('.text-danger');

                // Regex cho số điện thoại Việt Nam
                const phoneRegex = /^(0[3|5|7|8|9])+([0-9]{8})$/;

                if (sdt.length > 0) {
                    if (!phoneRegex.test(sdt)) {
                        $input.removeClass('is-valid').addClass('is-invalid');
                        if ($error.length === 0) {
                            $input.after('<span class="text-danger">Số điện thoại không hợp lệ (VD: 0901234567)</span>');
                        } else {
                            $error.text('Số điện thoại không hợp lệ (VD: 0901234567)');
                        }
                    } else {
                        $input.removeClass('is-invalid').addClass('is-valid');
                        $error.text('');
                    }
                }
            });

            // Validate email real-time với debounce
            let emailTimeout;
            $('#Email').on('input', function() {
                clearTimeout(emailTimeout);
                const email = $(this).val();
                const $input = $(this);
                let $error = $input.siblings('.text-danger');

                if (email.length > 0) {
                    emailTimeout = setTimeout(function() {
                        // Validate email format
                        const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

                        if (!emailRegex.test(email)) {
                            $input.removeClass('is-valid').addClass('is-invalid');
                            if ($error.length === 0) {
                                $input.after('<span class="text-danger">Email không đúng định dạng</span>');
                            } else {
                                $error.text('Email không đúng định dạng');
                            }
                        } else {
                            $input.removeClass('is-invalid').addClass('is-valid');
                            $error.text('');
                        }
                    }, 500); // Debounce 500ms
                }
            });

            // Validate ngày nhận xe
            $('#NgayNhanXe').on('change', function() {
                const ngayNhan = new Date($(this).val());
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const $input = $(this);
                let $error = $input.siblings('.text-danger');

                if (ngayNhan < today) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    if ($error.length === 0) {
                        $input.after('<span class="text-danger">Ngày nhận xe phải từ hôm nay trở đi</span>');
                    } else {
                        $error.text('Ngày nhận xe phải từ hôm nay trở đi');
                    }
                } else {
                    $input.removeClass('is-invalid').addClass('is-valid');
                    $error.text('');

                    // Validate lại ngày trả nếu có
                    validateNgayTra();
                    
                    // Cập nhật ngày trả dựa trên số ngày thuê hiện tại
                    const soNgayThue = parseInt($('#soNgayThueInput').val()) || 2;
                    const ngayTra = new Date(ngayNhan);
                    ngayTra.setDate(ngayNhan.getDate() + soNgayThue - 1);
                    $('#NgayTraXe').val(ngayTra.toISOString().split('T')[0]);
                }

                calculatePrice();
            });

            // Validate ngày trả xe
            $('#NgayTraXe').on('change', function() {
                validateNgayTra();
                calculatePrice();
            });

            function validateNgayTra() {
                const ngayNhan = new Date($('#NgayNhanXe').val());
                const ngayTra = new Date($('#NgayTraXe').val());
                const $input = $('#NgayTraXe');
                let $error = $input.siblings('.text-danger');

                if (ngayTra <= ngayNhan) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    if ($error.length === 0) {
                        $input.after('<span class="text-danger">Ngày trả xe phải sau ngày nhận xe</span>');
                    } else {
                        $error.text('Ngày trả xe phải sau ngày nhận xe');
                    }
                } else {
                    $input.removeClass('is-invalid').addClass('is-valid');
                    $error.text('');
                }
            }
            // Validate số ngày thuê
            $('#soNgayThueInput').on('input', function() {
                const $input = $(this);
                let value = parseInt($input.val());
                
                // Xử lý giá trị không hợp lệ
                if (isNaN(value) || value < 1) {
                    value = 1;
                    $input.val(value);
                } else if (value > 30) {
                    value = 30;
                    $input.val(value);
                }
                
                // Highlight input nếu đang ở giá trị cận
                if (value <= 1) {
                    $input.removeClass('is-valid').addClass('border-warning');
                } else if (value >= 30) {
                    $input.removeClass('is-valid').addClass('border-warning');
                } else {
                    $input.removeClass('border-warning').addClass('is-valid');
                }
                
                // Tự động tính toán ngày trả
                calculateFromDays();
            });

            // Xử lý khi focus ra khỏi input số ngày
            $('#soNgayThueInput').on('blur', function() {
                const $input = $(this);
                let value = parseInt($input.val());
                
                if (isNaN(value) || value < 1) {
                    $input.val(1);
                    calculateFromDays();
                }
            });

            // Character counter cho ghi chú
            $('#GhiChu').on('input', function() {
                const maxLength = 500;
                const currentLength = $(this).val().length;
                const remaining = maxLength - currentLength;

                // Hiển thị số ký tự còn lại
                if (!$(this).next('.char-counter').length) {
                    $(this).after('<small class="char-counter text-muted"></small>');
                }

                const $counter = $(this).next('.char-counter');
                $counter.text('Còn lại ' + remaining + ' ký tự');

                if (remaining < 50) {
                    $counter.removeClass('text-muted').addClass('text-warning');
                }
                if (remaining < 10) {
                    $counter.removeClass('text-warning').addClass('text-danger');
                }
            });

            // Log để debug
            console.log('Real-time validation và tùy chọn nhanh đã được load');
        });
    </script>
    

    <style>
        /* Thêm style cho validation */
        .is-valid {
            border-color: #28a745 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }

        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23dc3545' viewBox='-2 -2 7 7'%3e%3cpath stroke='%23dc3545' d='M0 0l3 3m0-3L0 3'/%3e%3ccircle r='.5'/%3e%3ccircle cx='3' r='.5'/%3e%3ccircle cy='3' r='.5'/%3e%3ccircle cx='3' cy='3' r='.5'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }

        .char-counter {
            float: right;
            margin-top: 5px;
        }
    </style>
}